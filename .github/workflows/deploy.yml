name: Deploy to AWS Windows Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Windows Server
      shell: pwsh
      run: |
        # Configurar credenciales
        $password = ConvertTo-SecureString "${{ secrets.SERVER_PASSWORD }}" -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential ("${{ secrets.SERVER_USERNAME }}", $password)
        
        # Conectar y ejecutar script de despliegue
        $session = New-PSSession -ComputerName ${{ secrets.SERVER_IP }} -Credential $credential -UseSSL -SessionOption (New-PSSessionOption -SkipCACheck -SkipCNCheck)
        
        Invoke-Command -Session $session -ScriptBlock {
          cd C:\inetpub\wwwroot\motopartes-manager
          
          Write-Host "ğŸ“¥ Descargando cambios..."
          git pull
          
          Write-Host "ğŸ“¦ Instalando dependencias del frontend..."
          npm install
          
          Write-Host "ğŸ—ï¸ Construyendo frontend..."
          npm run build
          
          Write-Host "ğŸ“¦ Instalando dependencias del backend..."
          cd whatsapp-backend
          npm install
          cd ..
          
          Write-Host "ğŸ”„ Reiniciando backend..."
          pm2 restart motopartes-backend
          
          Write-Host "âœ… Despliegue completado exitosamente!"
        }
        
        Remove-PSSession $session
